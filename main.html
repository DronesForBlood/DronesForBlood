<!DOCTYPE html>
<html>
<head>
<style>
div {
    padding: 25px 0px 0px 0px;
}
</style>
<meta charset="UTF-8">
<link rel="stylesheet" href="OpenLayers/v5.3.0-dist/ol.css" type="text/css">
<script src="OpenLayers/v5.3.0-dist/ol.js"></script>
<style>
    .map {
        height: 400px;
        width: 100%;
    }

</style>

<title>Page Title</title>
</head>
<body style="font-family:arial black;">

<h1>Drones for Blood</h1>
<p>Please select your position and destination.</p>

<div id="map" class="map"></div>
<script>		
    var markerOrder = true;
    var startSource = new ol.source.Vector({wrapX: false});
    var destinationSource = new ol.source.Vector({wrapX: false});
    var droneSource = new ol.source.Vector({wrapX: false});
    
    var startStyle = new ol.style.Style({
            image: new ol.style.Icon(/** @type {olx.style.IconOptions} */ ({
              anchor: [0.5, 0],
              anchorOrigin: 'bottom-left',
              anchorXUnits: 'fraction',
              anchorYUnits: 'fraction',
              src: "icons/home_marker.png"
            }))
        });
    
    var destinationStyle = new ol.style.Style({
            image: new ol.style.Icon(/** @type {olx.style.IconOptions} */ ({
                anchor: [0.5, 0],
                anchorOrigin: 'bottom-right',
                anchorXUnits: 'fraction',
                anchorYUnits: 'fraction',
                src: 'icons/goal_marker.png'
            }))
        });
    
    var droneStyle = new ol.style.Style({
            image: new ol.style.Icon(/** @type {olx.style.IconOptions} */ ({
                anchor: [0.5, 0.5],
                anchorXUnits: 'fraction',
                anchorYUnits: 'fraction',
                src: 'icons/drone.png'
            }))
        });
    
    var startLayer = new ol.layer.Vector({
        source: startSource,
        style: startStyle,
        ratio: 1
      });
    
    var destinationLayer = new ol.layer.Vector({
        source: destinationSource,
        style: destinationStyle
      });
    
    var droneLayer = new ol.layer.Vector({
        source: droneSource,
        style: droneStyle
      });
    
    var raster = new ol.layer.Tile({
        source: new ol.source.OSM()
      });
    
    var map = new ol.Map({
        target: 'map',
        layers: [raster, startLayer, destinationLayer, droneLayer],
        view: new ol.View({
          center: ol.proj.fromLonLat([10.42, 55.37]),
          zoom: 14
        })
      });

    map.on('click', function(e){
        var translated = new ol.proj.transform(e.coordinate, "EPSG:900913" ,"EPSG:4326");
        if (markerOrder){
            startSource.clear();
            var feature = new ol.Feature({
                geometry: new ol.geom.Point(e.coordinate)
            }); 	
            feature.setStyle(startStyle);
            startSource.addFeature(feature);
            document.getElementById("startLat").value = Math.round(translated[1] * 10000000) / 10000000;   
            document.getElementById("startLon").value = Math.round(translated[0] * 10000000) / 10000000;
            markerOrder = false;
       }
       else {
            destinationSource.clear();
            var feature = new ol.Feature({
                geometry: new ol.geom.Point(e.coordinate)
            }); 	
            feature.setStyle(destinationStyle);
            destinationSource.addFeature(feature);
            document.getElementById("endLat").value = Math.round(translated[1] * 10000000) / 10000000;
            document.getElementById("endLon").value = Math.round(translated[0] * 10000000) / 10000000;
            markerOrder = true;
       }
        
    });
    
function addStartMarker(markPos){
	startSource.clear();
    var feature = new ol.Feature({
        geometry: new ol.geom.Point(markPos.lon, markPos.lat), 
    }); 	
    feature.setStyle(startStyle);
    startSource.addFeature(feature);
};

function addStartMarkerManual(){
	var pattern = /\d{2}\.\d{7}/;
	if (pattern.test(document.getElementById("startLat").value) && pattern.test(document.getElementById("startLon").value))
	{
		startSource.clear();
        markPos = new ol.proj.transform([Number(document.getElementById("startLon").value), Number(document.getElementById("startLat").value)], "EPSG:4326", "EPSG:3857");
        var feature = new ol.Feature({
            geometry: new ol.geom.Point(markPos),
        }); 	
        feature.setStyle(startStyle);
        startSource.addFeature(feature);        
	}
};

function addEndMarker(markPos){
	destinationSource.clear();
    var feature = new ol.Feature({
        geometry: new ol.geom.Point(markPos), 
    }); 	
    feature.setStyle(destinationStyle);
    destinationSource.addFeature(feature);
};

function addEndMarkerManual(){
	var pattern = /\d{2}\.\d{7}/;
    console.info("End Marker Changed!");
	if (pattern.test(document.getElementById("endLat").value) && pattern.test(document.getElementById("endLon").value))
	{
		destinationSource.clear();
		markPos = new ol.proj.transform([Number(document.getElementById("endLon").value), Number(document.getElementById("endLat").value)], "EPSG:4326", "EPSG:3857");
        var feature = new ol.Feature({
            geometry: new ol.geom.Point(markPos), 
        }); 	
        feature.setStyle(destinationStyle);
        destinationSource.addFeature(feature);
	}
};

function addDroneMarker(){
	droneSource.clear();
	markPos = new ol.proj.transform([Number(document.getElementById("droneLon").value), Number(document.getElementById("droneLat").value)], "EPSG:4326", "EPSG:3857");
    var feature = new ol.Feature({
        geometry: new ol.geom.Point(markPos),
    });  	
    feature.setStyle(droneStyle);
    droneSource.addFeature(feature);
};
</script>
<div style="height:30px"></div>

<form style="display:inline-block;" onsubmit="publishTopic();return false">
<label>Start Position:</label>
<input type = "number" id = "startLat" step="0.0000001" max="90" min="-90" placeholder="Latitude" required pattern=.{1} oninput="addStartMarkerManual()"/>
<input type = "number" id = "startLon" step="0.0000001" max="180" min="-180" placeholder="Longitude" required pattern=.{1} oninput="addStartMarkerManual()"/>
<div></div>

<label>End Position:</label>
<input type = "number" id = "endLat" step="0.0000001" max="90" min="-90" placeholder="Latitude" required pattern=.{1} oninput="addEndMarkerManual()"/>
<input type = "number" id = "endLon" step="0.0000001" max="180" min="-180" placeholder="Longitude" required pattern=.{1} oninput="addEndMarkerManual()"/>
<div></div>
<nobr>
<input type="submit" value="Request"/>
<input type="checkbox" id="package" value="1"/> Package attached
</nobr>
</form>

<div></div>

<form style="display:inline-block;" onsubmit="publishStart();return false">
<input type="submit" value="Start" />
</form>

<div></div>

<form onsubmit="addDroneMarker();return false">
<b>Current Drone Position:<br></b> 
<input type = "number" id = "droneLat" step="0.0000001" placeholder="Latitude" required pattern=.{1} /> <!-- Should be disabled -->
<input type = "number" id = "droneLon" step="0.0000001" placeholder="Longitude" required pattern=.{1} />
<input type="submit" value="Place Drone"/>
</form>

<!-- ROS HTML LINK http://wiki.ros.org/roslibjs/Tutorials/BasicRosFunctionality -->
<script type="text/javascript" src="http://static.robotwebtools.org/EventEmitter2/current/eventemitter2.min.js"></script>
<script type="text/javascript" src="http://static.robotwebtools.org/roslibjs/current/roslib.min.js"></script>
<script type="text/javascript">
var destinationSent = false;
var ros = new ROSLIB.Ros({
	url : 'ws://localhost:9090'
	});
	
	ros.on('connection', function() {
		console.log('Connected to server.');
	});
	ros.on('error', function(error) {
		console.log('Error connecting to websocket server: ', error);
    });
	ros.on('close', function() {
        console.log('Connection to websocket server closed.');
    });

var droneDestination = new ROSLIB.Topic({
	ros : ros,
	name : "/dronelink/destination",
	messageType : "dronelink/mavlink_lora_pos"
});
    
var droneStart = new ROSLIB.Topic({
	ros : ros,
	name : "/dronelink/start",
	messageType : "std_msgs/Int16MultiArray"
});

var dronePosition = new ROSLIB.Topic({
    ros : ros,
    name : "/mavlink_pos",
    messageType : "dronelink/mavlink_lora_pos"
});   

dronePosition.subscribe(function(message) {
	document.getElementById("droneLat").value = message.lat;
	document.getElementById("droneLon").value = message.lon;	
	addDroneMarker();
});   

function publishStart(){
	if (destinationSent){
		var msg = new ROSLIB.Message({
			layout: {
				dim: [{
					label: "Start",
					size: 1,
					stride: 0},
				     {
					label: "Package",
					size: 1,
					stride: 0}],
				data_offset: 0
			},
			data:[1, Number(document.getElementById("package").value)]

		});
		droneStart.publish(msg);
		console.info(msg);
	}
	else {
		alert("You must send a request first!");
	}
};

function publishTopic(){
	var msg = new ROSLIB.Message({
		time_usec: 0,
        	lat : document.getElementById("endLat").value,
        	lon: document.getElementById("endLon").value,
        	alt: 0.0,
        	relative_alt: 0.0,
        	heading: 0.0,
        	vx: 0.0,
        	vy: 0.0,
        	vz: 0.0
	});
	droneDestination.publish(msg);
	destinationSent = true;
};
</script>
</body>
</html>
